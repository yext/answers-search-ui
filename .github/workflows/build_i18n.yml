name: Build Answers i18n assets

on:
  workflow_call:
    inputs:
      build_script:
        required: false
        default: build-locales
        type: string

jobs:
  create_language_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - uses: actions/setup-node@v3
      with:
        node-version: 16
        cache: 'npm'
    - id: set-matrix
      run: |
        echo matrix=$(node -e 'console.log(require("./conf/i18n/constants").ALL_LANGUAGES)') >> $GITHUB_OUTPUT

  build:
    needs: create_language_matrix
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: ${{ fromJson(needs.create_language_matrix.outputs.matrix) }}
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Use Node.js 16
      uses: actions/setup-node@v3
      with:
        node-version: 16
        cache: 'npm'
    - run: npm ci
    - run: LANGUAGE=${{ matrix.language }} npm run ${{ inputs.build_script }}
    - run: |
        if [ "${{ matrix.language }}" == "en" ]; then 
          npm run size
        fi
    - name: Create build-output artifact
      uses: actions/upload-artifact@v4
      with:
        name: build-output-${{ matrix.language }}
        path: dist/

  merge_multiple_artifacts:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Merge into build-output-temp Artifact
        uses: actions/upload-artifact/merge@v4
        with:
          name: build-output-temp
          pattern: build-output-*
          delete-merged: true

  overwrite_artifact:
    needs: merge_multiple_artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Download build-output-temp artifact
        uses: actions/download-artifact@v4
        with:
          name: build-output-temp
          path: dist/
      - name: Overwrite build-output artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          overwrite: true
